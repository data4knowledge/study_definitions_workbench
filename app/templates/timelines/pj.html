{% extends "shared/_main_layout.html" %}

{% block user_content %}
  {% with request=request, user=user %}
    {% include "shared/partials/user.html" %}
  {% endwith %}    
{% endblock %}  
{% block menu_content %}
  {% with data=data %}
    {% include "shared/partials/soa_view_menu.html" %}
  {% endwith %}
  {% with data=data %}
    {% include "shared/partials/soa_export_menu.html" %}
  {% endwith %}
  {% if data['fhir']['enabled'] %}
    {% with data=data %}
      {% include "shared/partials/soa_transmit_menu.html" %}
    {% endwith %} 
  {% endif %} 
{% endblock %}

{% block main_content %}
  <div class="mt-3 row">
    <div class="col-12">
      {% set title = "Patient Journey" %}
      {% set subtitle = "A detailed view of study visits and activities" %}
      {% with title=title, subtitle=subtitle %}
        {% include "shared/partials/header.html" %}
      {% endwith %}    
    </div>
  </div>
  <div class="mt-3 row">
    <div class="col-12">
      <div class="card card-body rounded-3 h-100">
        <div>
            <input type="hidden" id="json_input"  name="json_input" value="{{data['json']}}"/>
        </div>
        <!-- Tab navigation -->
        <ul class="nav nav-tabs" id="visitTabs" role="tablist"></ul>
        <!-- Tab content -->
        <div class="tab-content mt-3" id="visitTabContent"></div>
        <div class="tooltip" id="tooltip"></div>
      </div>
    </div>
  </div>
{% endblock %}

{% block additional_css %}
  <style>
      .visit-info {
          background-color: #f8f9fa;
          border-left: 3px solid #0d6efd;
          padding: 12px;
          margin-bottom: 15px;
          border-radius: 4px;
      }
      
      .info-item {
          margin-bottom: 5px;
      }
      
      .info-label {
          font-weight: 600;
          color: #495057;
          margin-right: 8px;
      }
      
      .info-value {
          color: #6c757d;
      }

      .nav-tabs {
          border-bottom: 2px solid #dee2e6;
      }

      .nav-tabs .nav-link {
          color: #495057;
          font-weight: 500;
          border: none;
          border-bottom: 3px solid transparent;
          padding: 12px 20px;
          margin-bottom: -2px;
      }

      .nav-tabs .nav-link:hover {
          border-bottom-color: #0d6efd;
          background-color: transparent;
      }

      .nav-tabs .nav-link.active {
          color: #0d6efd;
          border-bottom-color: #0d6efd;
          background-color: transparent;
      }

      .tab-pane {
          padding: 20px 0;
      }
      
      .timeline-container {
          min-height: 150px;
          overflow-x: auto;
          padding: 20px 0;
          display: flex;
          justify-content: center;
          align-items: center;
      }
      
      .activity-node {
          cursor: pointer;
      }
      
      .activity-circle {
          fill: #0d6efd;
          stroke: #0b5ed7;
          stroke-width: 2;
      }
      
      .activity-circle:hover {
          fill: #0b5ed7;
          r: 10;
      }
      
      .activity-label {
          fill: #212529;
          font-size: 14spx;
          font-weight: 500;
          text-anchor: middle;
          pointer-events: none;
      }
      
      .timeline-path {
          fill: none;
          stroke: #626467;
          stroke-width: 3;
          stroke-dasharray: 4, 4;
      }
      
      .no-activities {
          text-align: center;
          color: #6c757d;
          padding: 40px;
          font-style: italic;
      }
      
      .tooltip {
          position: absolute;
          background-color: white;
          border: 1px solid #dee2e6;
          border-radius: 4px;
          padding: 10px 12px;
          pointer-events: none;
          opacity: 0;
          transition: opacity 0.2s;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          max-width: 350px;
          z-index: 1000;
      }
      
      .tooltip.visible {
          opacity: 1;
      }
      
      .tooltip-title {
          font-weight: 600;
          font-size: 14px;
          color: #212529;
          margin-bottom: 6px;
          border-bottom: 1px solid #dee2e6;
          padding-bottom: 4px;
      }
      
      .tooltip-content {
          font-size: 12px;
          color: #6c757d;
      }
      
      .procedure-item {
          padding-left: 15px;
          margin: 3px 0;
      }
      
      .procedure-item:before {
          content: "â€¢";
          color: #0d6efd;
          font-weight: bold;
          margin-right: 8px;
          margin-left: -15px;
      }
  </style>
{% endblock %}

{% block additional_js %}
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript">
        let rawJSON = document.getElementById('json_input').value;
        let data = JSON.parse(rawJSON);
    
        
        // Configuration for activity timelines
        const config = {
            nodeRadius: 6,
            colWidth: 180,
            nodeSpacing: 70,
            nodesPerCol: 6,
            margin: { top: 60, right: 30, bottom: 60, left: 80 }
        };
        
        // Get visits data
        const visits = data.visits || [];
        
        // Global tooltip
        const tooltip = d3.select("#tooltip");
        
        // Create visit tabs
        function createVisitTabs() {
            const tabNav = document.getElementById('visitTabs');
            const tabContent = document.getElementById('visitTabContent');
            
            // Filter visits with titles
            const validVisits = visits.filter(visit => visit.title && visit.title.trim() !== '');
            
            if (validVisits.length === 0) {
                tabContent.innerHTML = '<div class="no-activities">No visits available</div>';
                return;
            }
            
            validVisits.forEach((visit, index) => {
                const visitIndex = visits.indexOf(visit);
                const isFirst = index === 0;
                
                // Create tab button
                const tabButton = document.createElement('li');
                tabButton.className = 'nav-item';
                tabButton.setAttribute('role', 'presentation');
                tabButton.innerHTML = `
                    <button class="nav-link ${isFirst ? 'active' : ''}" 
                            id="visit-tab-${visitIndex}" 
                            data-bs-toggle="tab" 
                            data-bs-target="#visit-pane-${visitIndex}" 
                            type="button" 
                            role="tab" 
                            aria-controls="visit-pane-${visitIndex}" 
                            aria-selected="${isFirst ? 'true' : 'false'}">
                        <i class="bi bi-calendar-event"></i> ${visit.title}
                    </button>
                `;
                tabNav.appendChild(tabButton);
                
                // Create tab pane
                const tabPane = document.createElement('div');
                tabPane.className = `tab-pane fade ${isFirst ? 'show active' : ''}`;
                tabPane.id = `visit-pane-${visitIndex}`;
                tabPane.setAttribute('role', 'tabpanel');
                tabPane.setAttribute('aria-labelledby', `visit-tab-${visitIndex}`);
                
                // Visit information
                const info = document.createElement('div');
                info.className = 'visit-info';
                info.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">Visit:</span>
                        <span class="info-value">${visit.title}</span>
                        <span class="badge bg-primary ms-2">Visit #${visitIndex + 1}</span>
                    </div>
                    ${visit.type ? `<div class="info-item"><span class="info-label">Type:</span><span class="info-value">${visit.type}</span></div>` : ''}
                    ${visit.duration ? `<div class="info-item"><span class="info-label">Duration:</span><span class="info-value">${visit.duration}</span></div>` : ''}
                    ${visit.timing ? `<div class="info-item"><span class="info-label">Timing:</span><span class="info-value">${visit.timing}</span></div>` : ''}
                    ${visit.notes ? `<div class="info-item"><span class="info-label">Notes:</span><span class="info-value">${visit.notes}</span></div>` : ''}
                `;
                tabPane.appendChild(info);
                
                // Activities section header
                const activitiesHeader = document.createElement('h6');
                activitiesHeader.className = 'mt-3 mb-3';
                activitiesHeader.innerHTML = '<strong>Activities Timeline</strong>';
                tabPane.appendChild(activitiesHeader);
                
                // Timeline container
                const timelineContainer = document.createElement('div');
                timelineContainer.className = 'timeline-container';
                timelineContainer.id = `timeline-${visitIndex}`;
                tabPane.appendChild(timelineContainer);
                
                tabContent.appendChild(tabPane);
                
                // Create timeline for this visit's activities
                // Only render the first tab immediately, others will be rendered when clicked
                if (isFirst) {
                    createActivityTimeline(visit.activities || [], `timeline-${visitIndex}`);
                }
            });
            
            // Add event listener to render timelines when tabs are shown
            const tabButtons = tabNav.querySelectorAll('button[data-bs-toggle="tab"]');
            tabButtons.forEach((button, index) => {
                button.addEventListener('shown.bs.tab', function (event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    const timelineId = targetId.replace('#visit-pane-', 'timeline-');
                    const timelineContainer = document.getElementById(timelineId);
                    
                    // Only create timeline if it hasn't been created yet
                    if (timelineContainer && timelineContainer.innerHTML === '') {
                        const visitIndex = visits.indexOf(validVisits[index]);
                        createActivityTimeline(validVisits[index].activities || [], timelineId);
                    }
                });
            });
        }
        
        // Create serpentine timeline for activities
        function createActivityTimeline(activities, containerId) {
            const container = d3.select(`#${containerId}`);
            
            // Filter out activities without titles
            const validActivities = activities.filter(a => a.title && a.title.trim() !== '');
            
            if (validActivities.length === 0) {
                container.html('<div class="no-activities">No activities recorded for this visit</div>');
                return;
            }
            
            // Calculate positions
            const positions = calculateSerpentineLayout(validActivities);
            
            // Calculate SVG dimensions
            const maxX = Math.max(...positions.map(p => p.x), 0);
            const maxY = Math.max(...positions.map(p => p.y), 0);
            const svgWidth = maxX + config.margin.left + config.margin.right + 100;
            const svgHeight = maxY + config.margin.top + config.margin.bottom + 50;
            
            // Create SVG
            const svg = container.append("svg")
                .attr("width", svgWidth)
                .attr("height", svgHeight);
            
            const g = svg.append("g")
                .attr("transform", `translate(${config.margin.left},${config.margin.top})`);
            
            // Draw serpentine path
            g.append("path")
                .attr("class", "timeline-path")
                .attr("d", createSerpentinePath(positions));
            
            // Create activity nodes
            const nodes = g.selectAll(".activity-node")
                .data(positions)
                .enter()
                .append("g")
                .attr("class", "activity-node")
                .attr("transform", d => `translate(${d.x},${d.y})`);
            
            // Add circles
            nodes.append("circle")
                .attr("class", "activity-circle")
                .attr("r", config.nodeRadius)
                .on("mouseover", function(event, d) {
                    showTooltip(event, d.activity);
                })
                .on("mouseout", function() {
                    hideTooltip();
                });
            
            // Add labels
            nodes.append("text")
                .attr("class", "activity-label")
                .attr("y", -12)
                .each(function(d) {
                    const text = d3.select(this);
                    const words = d.activity.title.split(' ');
                    
                    // Wrap text if too long
                    if (words.length > 2) {
                        text.append("tspan")
                            .attr("x", 0)
                            .text(words.slice(0, 2).join(' '));
                        text.append("tspan")
                            .attr("x", 0)
                            .attr("dy", "1.1em")
                            .text(words.slice(2).join(' '));
                    } else {
                        text.text(d.activity.title);
                    }
                });
        }
        
        // Calculate serpentine layout (vertical orientation)
        function calculateSerpentineLayout(activities) {
            const positions = [];
            const nodesPerCol = config.nodesPerCol;
            
            activities.forEach((activity, index) => {
                const col = Math.floor(index / nodesPerCol);
                const row = index % nodesPerCol;
                
                // Alternate direction for serpentine effect (vertical)
                const y = col % 2 === 0 
                    ? row * config.nodeSpacing 
                    : (nodesPerCol - 1 - row) * config.nodeSpacing;
                const x = col * config.colWidth;
                
                positions.push({ x, y, activity, index });
            });
            
            return positions;
        }
        
        // Create serpentine path (vertical orientation)
        function createSerpentinePath(positions) {
            if (positions.length === 0) return '';
            
            let path = `M ${positions[0].x},${positions[0].y}`;
            
            for (let i = 1; i < positions.length; i++) {
                const prev = positions[i - 1];
                const curr = positions[i];
                
                // Check if we're at a column transition
                const prevCol = Math.floor(prev.index / config.nodesPerCol);
                const currCol = Math.floor(curr.index / config.nodesPerCol);
                
                if (prevCol !== currCol) {
                    // Create a semi-circular arc transition between columns
                    const dx = curr.x - prev.x;
                    const dy = curr.y - prev.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // Determine curve direction based on whether we're at top or bottom
                    // Even columns go down (top to bottom), odd columns go up (bottom to top)
                    // When transitioning from even to odd column, we're at the bottom (curve down)
                    // When transitioning from odd to even column, we're at the top (curve up)
                    const isAtBottom = prevCol % 2 === 0;
                    const curveDirection = isAtBottom ? 1 : -1;
                    const offset = distance * 0.3 * curveDirection;
                    
                    const ctrl1X = prev.x + dx * 0.25;
                    const ctrl1Y = prev.y + offset;
                    const ctrl2X = prev.x + dx * 0.75;
                    const ctrl2Y = curr.y + offset;
                    
                    path += ` C ${ctrl1X},${ctrl1Y} ${ctrl2X},${ctrl2Y} ${curr.x},${curr.y}`;
                } else {
                    // Straight line within column
                    path += ` L ${curr.x},${curr.y}`;
                }
            }
            
            return path;
        }
        
        // Show tooltip
        function showTooltip(event, activity) {
            let html = `<div class="tooltip-title">${activity.title}</div>`;
            
            if (activity.procedures && activity.procedures.length > 0) {
                html += '<div class="tooltip-content"><strong>Procedures:</strong></div>';
                activity.procedures.forEach(proc => {
                    html += `<div class="procedure-item">${proc}</div>`;
                });
            }
            
            if (activity.notes && activity.notes.trim() !== '') {
                html += `<div class="tooltip-content mt-2"><strong>Notes:</strong><br>${activity.notes}</div>`;
            }
            
            tooltip.html(html)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 15) + "px")
                .classed("visible", true);
        }
        
        // Hide tooltip
        function hideTooltip() {
            tooltip.classed("visible", false);
        }
        
        // Initialize
        createVisitTabs();
        
        console.log(`Created ${visits.filter(v => v.title && v.title.trim() !== '').length} visit tabs with activity timelines`);
    </script>
{% endblock %}
